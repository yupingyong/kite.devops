@page "/Server/Console/{Id:guid}"
@layout ConsoleLayout

@using Kite.DevOps.Domain.Server
@using Kite.DevOps.Application.Contracts.Server
@using Kite.DevOps.Application.Contracts.Server.Dtos
@using Mapster
@using Kite.DevOps.Domain.Shared.Enums
@using System.Collections.Concurrent
@inject ToastService toastService
@inject IServerAppService serverAppService
@inject IServerGroupAppService serverGroupAppService
@inject IServerClientManager serverClientManager


<Console Items="@ConsoleMessages" HeaderText="@HeaderText" IsAutoScroll="true" Height="750" />
<BootstrapInput @bind-Value="CommandText" PlaceHolder="请输入命令行" OnEnterAsync="OnEnterAsync" />

@code {
    [Parameter]
    public Guid Id { get; set; }
    //控制台输入信息
    private ConcurrentQueue<ConsoleMessageItem> ConsoleMessages { get; set; } = new ConcurrentQueue<ConsoleMessageItem>();
    //命令行文本
    private string CommandText { get; set; }

    private string HeaderText { get; set; }

    public ServerDto Server { get; set; }

    protected async override void OnInitialized()
    {
        base.OnInitialized();
        CommandText = "";
        var serverResult = await serverAppService.GetAsync(Id);
        if (serverResult.Code == 0)
        {
            Server = serverResult.Data;
            HeaderText = $"{Server.ServerName}[{Server.Host}]";
            //连接服务器
            var connectResult = await serverClientManager.ConnectAsync(Server.Host, Server.Port, Server.UserName, Server.Password);
            if (connectResult)
            {
                ConsoleMessages.Enqueue(new ConsoleMessageItem()
                    {
                        Message = "###=> 服务器连接成功"
                    });
                StateHasChanged();

            }
        }
    }

    private async Task OnEnterAsync(string val)
    {
        ConsoleMessages.Enqueue(new ConsoleMessageItem()
            {
                Message = val
            });
        CommandText = "";
        StateHasChanged();
        //创建命令流
        await serverClientManager.CreateShellCommandStreamAsync();
        await serverClientManager.WriteShellCommandStreamAsync(val);
        await serverClientManager.ReadByEndOfAsync((res) =>
        {
            if (ConsoleMessages.Count == 1000)
            {
                ConsoleMessages.TryDequeue(out ConsoleMessageItem msg);
            }
            ConsoleMessages.Enqueue(new ConsoleMessageItem()
            {
                Message = $"[{DateTime.Now.ToString("HH:mm:ss")}] {res}"
            });
            this.InvokeAsync(() =>
            {
                StateHasChanged();
            });
        });
        //await serverClientManager.CloseShellCommandStreamAsync();
    }
}
