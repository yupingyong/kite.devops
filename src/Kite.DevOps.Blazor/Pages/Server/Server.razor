@page "/Server"

@using Kite.DevOps.Application.Contracts.Server
@using Kite.DevOps.Application.Contracts.Server.Dtos
@using Mapster
@using Kite.DevOps.Domain.Shared.Enums
@inject ToastService toastService
@inject IServerAppService serverAppService

<div class="row">
    <div class="col=12">
        <Button OnClick="@OnAddAsync" Color="Color.Primary">添加服务器</Button>
    </div>
</div>
<div class="row" style="margin-top:10px;">
    <table class="table">
      <thead class="table-light">
        <tr>
            <th>服务器名</th>
            <th>服务器组名</th>
            <th>服务器主机</th>
            <th>端口号</th>
            <th>用户名</th>
            <th>密码</th>
            <th>容器编排版本</th>
            <th>系统标签</th>
            <th>备注信息</th>
            <th>创建时间</th>
           
            <th>操作</th>
        </tr>
      </thead>
      <tbody>
            @if (Servers != null && Servers.Any())
            {
                foreach (var item in Servers)
                {
                    <tr>
                        <td>@item.ServerName</td>
                        <td>@item.GroupName</td>
                        <td>@item.Host</td>
                        <td>@item.Port</td>
                        <td>@item.UserName</td>
                        <td>@item.Password</td>
                        <td>@(item.DockerComposeVersion==DockerComposeVersionEnum.V1?"V1":"V2") </td>
                        <td>@item.SystemTag</td>
                        <td>@item.Remarks</td>
                        <td>@item.Created</td>
                        <td>
                            <div class="btn-group" role="group">
                                <Button Color="Color.Info" Size="Size.ExtraSmall" OnClick="@(e=>OnUpdateAsync(item.Id))">编辑</Button>
                                <PopConfirmButton  Size="Size.ExtraSmall" Placement="Placement.Bottom" Color="Color.Danger" ConfirmIcon="fa fa-exclamation-triangle text-danger"
                      ConfirmButtonColor="Color.Danger" Text="删除" Content="确定删除数据吗？" Icon="fa fa-fa fa-fw" IsAsync="true"
                      OnConfirm="@(()=>OnDeleteAsync(item.Id))" />
                            </div>
                        </td>
                    </tr>
              }
            }
        </tbody>
    </table>
    
</div>
<div class="row col-12"  style="margin-top:15px;">
    <Pagination PageItems="@PageSize" PageItemsSource="@(new int[] { 10,20 })" TotalCount="@TotalCount" OnPageClick="@OnPageClick" OnPageItemsChanged="@OnPageItemsChanged"></Pagination>
</div>

<Modal @ref="Modal">
    <ModalDialog  IsScrolling="true" Title="添加服务器" IsCentered="true" Size="Size.Large" ShowCloseButton="false">
        <BodyTemplate >
          <NewServer OnClickCallback="OnAddCallbackAsync"></NewServer>
        </BodyTemplate>
    </ModalDialog>
</Modal>

<Modal @ref="UpdateModal">
    <ModalDialog  IsScrolling="true" Title="服务器编辑" IsCentered="true" Size="Size.Large" ShowCloseButton="false">
        <BodyTemplate >
           <UpdateServer Model="@UpdateModel" OnClickCallback="OnUpdateCallbackAsync"></UpdateServer>
        </BodyTemplate>
    </ModalDialog>
</Modal>

@code {
    private Modal Modal;

    private Modal UpdateModal;

    public UpdateServerDto UpdateModel { get; set; }
    //分页数据

    private List<ServerDto>? Servers { get; set; }

    private int TotalCount { get; set; } = 0;
    private int PageSize { get; set; } = 10;
    private int PageIndex { get; set; } = 1;
    /// <summary>
    /// OnInitialized 方法
    /// </summary>
    protected override void OnInitialized()
    {
        OnQueryAsync();
        base.OnInitialized();
    }
    #region 管理员编辑更新
    private async void OnUpdateAsync(int id)
    {
        UpdateModel= await GetAsync(id);
        await UpdateModal.Toggle();
    }
    private async Task<UpdateServerDto> GetAsync(int id)
    {
        var result = await serverAppService.GetAsync(id);
        if (result.Code != 0 || result.Data == null)
        {
            await toastService.Warning("系统警告", "数据不存在");
        }
        var model= TypeAdapter.Adapt<UpdateServerDto>(result.Data);
        return model;
    }
    private async void OnUpdateCallbackAsync()
    {
        await UpdateModal.Close();
        OnQueryAsync();
    }
    #endregion
    #region 新增管理员
    private async void OnAddAsync()
    {
        await Modal.Toggle();
    }
    private async void OnAddCallbackAsync()
    {
        await Modal.Close();
        OnQueryAsync();
    }
    #endregion
    private async Task OnDeleteAsync(int id)
    {
        var result= await serverAppService.DeleteAsync(id);
        if (result.Code == 0)
        {
            OnQueryAsync();
            await toastService.Success("系统通知","数据删除成功!");
            return;
        }
        await toastService.Warning("系统警告","数据删除失败");
    }

    private Task OnPageClick(int pageIndex, int pageItems)
    {
        PageIndex = pageIndex;
        OnQueryAsync();
        return Task.CompletedTask;
    }
    private Task OnPageItemsChanged(int pageItems)
    {
        PageIndex=1;
        PageSize = pageItems;
        OnQueryAsync();
        return Task.CompletedTask;
    }

    private async void OnQueryAsync()
    {
        var result = await serverAppService.GetListAsync(null, "", PageIndex, PageSize);

        if (result.Code == 0)
        {
            Servers = result.Data;
            TotalCount = result.Count;
            StateHasChanged();
        }
        else
        {
            await toastService.Warning("系统警告", "数据加载失败");
        }
    }

}
